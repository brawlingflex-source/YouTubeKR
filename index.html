<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>–¢—ë–º–Ω—ã–π YouTube ¬∑ –ë–ª–æ–≥–µ—Ä / –ê–¥–º–∏–Ω</title>
    <!-- Firebase compat (8.x) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        body {
            background: #0f0f0f;
            color: #eee;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 12px;
        }
        #app {
            width: 100%;
            max-width: 500px;
            background: #1e1e1e;
            border-radius: 28px;
            padding: 20px 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .hidden { display: none !important; }
        .card {
            background: #2a2a2a;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #3a3a3a;
        }
        h2, h3 {
            font-weight: 500;
            letter-spacing: 0.2px;
        }
        h2 { font-size: 1.5rem; margin-bottom: 16px; color: #fff; }
        h3 { font-size: 1.2rem; margin-bottom: 12px; color: #ddd; }
        button, .btn {
            background: #3a3a3a;
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 36px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #555;
            box-shadow: 0 2px 5px #00000055;
        }
        button:active { background: #505050; transform: scale(0.97); }
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
        input, textarea {
            width: 100%;
            padding: 14px 16px;
            background: #1a1a1a;
            border: 1px solid #3d3d3d;
            border-radius: 30px;
            color: white;
            font-size: 1rem;
            margin-bottom: 12px;
            outline: none;
        }
        input:focus, textarea:focus { border-color: #7b7bff; }
        textarea { min-height: 80px; resize: vertical; }
        .row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin: 8px 0;
        }
        .video-item {
            background: #1f1f1f;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ff5555;
        }
        .video-metrics-column {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: #2a2a2a;
            border-radius: 16px;
            padding: 12px;
            margin: 10px 0 12px;
            border: 1px solid #3f3f3f;
        }
        .metric-row {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
        }
        .metric-row span:first-child {
            min-width: 24px;
            font-size: 1.1rem;
        }
        .metric-row .metric-value {
            color: #fff;
            font-weight: 500;
        }
        .video-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .small-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
            background: #333;
        }
        .danger-btn { background: #8b2c2c; border-color: #b33; }
        .success-btn { background: #2c6b2c; }
        .admin-control {
            background: #252525;
            border-radius: 18px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 8px;
        }
        .stat-edit-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            background: #2e2e2e;
            padding: 8px 12px;
            border-radius: 40px;
        }
        .stat-edit-row label {
            min-width: 40px;
            font-size: 1.2rem;
        }
        .stat-edit-row input {
            flex: 2;
            min-width: 100px;
            margin-bottom: 0;
            padding: 10px 14px;
            background: #1f1f1f;
            border-radius: 40px;
            border: 1px solid #5a5a5a;
        }
        .subs-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #2b2b2b;
            border-radius: 40px;
            padding: 10px 20px;
            margin: 15px 0;
        }
        .subs-edit {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .subs-edit input {
            width: 90px;
            margin-bottom: 0;
            text-align: center;
        }
        .plus-icon {
            font-size: 2.2rem;
            background: #2d5f9e;
            width: 60px;
            height: 60px;
            border-radius: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 8px auto 0;
            box-shadow: 0 4px 12px #1a3f6a;
            cursor: pointer;
            user-select: none;
            border: 2px solid #8ab2ff;
        }
        .scrollable {
            max-height: 380px;
            overflow-y: auto;
            padding-right: 4px;
        }
        .scrollable::-webkit-scrollbar {
            width: 5px;
            background: #2a2a2a;
        }
        .scrollable::-webkit-scrollbar-thumb {
            background: #777;
            border-radius: 10px;
        }
        .channel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .delete-channel {
            background: transparent;
            border: 1px solid #a55;
            color: #faa;
            padding: 8px 16px;
        }
        .stored-badge {
            background: #2d5f2d;
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 0.8rem;
            color: #b0ffb0;
            margin-left: 10px;
        }
        .subs-display {
            background: #2d2d5f;
            padding: 8px 16px;
            border-radius: 40px;
            display: inline-block;
            margin-bottom: 12px;
            border: 1px solid #6a6aff;
        }
        .monetization-display {
            background: #1e4d2e;
            padding: 12px 20px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            border: 1px solid #2ecc71;
        }
        .monetization-text {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2ecc71;
        }
        .withdraw-btn {
            background: #2ecc71;
            color: #000;
            font-weight: bold;
            padding: 8px 20px;
            border: none;
            border-radius: 36px;
            cursor: pointer;
        }
        .withdraw-btn:hover {
            background: #27ae60;
        }
        .short-number {
            font-weight: 500;
        }
        .date-badge {
            background: #333;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .admin-video-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .video-earnings {
            background: #1a3a2a;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.85rem;
            color: #2ecc71;
            margin-left: 8px;
        }
        .video-earnings-new {
            background: #2ecc71;
            color: #000;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.85rem;
            margin-left: 8px;
            font-weight: bold;
        }
        .welcome-message {
            text-align: center;
            color: #888;
            margin: 20px 0;
            font-style: italic;
        }
    </style>
</head>
<body>
<div id="app">

    <!-- === –≠–ö–†–ê–ù –í–´–ë–û–†–ê –†–û–õ–ò === -->
    <div id="role-screen" class="card">
        <h2 style="text-align: center;">üëÅÔ∏è –¢—ë–º–Ω—ã–π YouTube</h2>
        <div style="display: flex; gap: 15px; margin-top: 25px;">
            <button style="flex:1;" id="choose-blogger">üìπ –ë–ª–æ–≥–µ—Ä</button>
            <button style="flex:1;" id="choose-admin">üõ°Ô∏è –ê–¥–º–∏–Ω</button>
        </div>
        <div id="existing-channel-info" style="margin-top: 25px; text-align: center; font-size:0.95rem; color: #aaa;">
            <!-- –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –∫–∞–Ω–∞–ª —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω -->
        </div>
    </div>

    <!-- === –§–û–†–ú–ê –í–•–û–î–ê –î–õ–Ø –ë–õ–û–ì–ï–†–ê (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∫–∞–Ω–∞–ª–∞) === -->
    <div id="blogger-login" class="card hidden">
        <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</h3>
        <input type="text" id="blogger-channel-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞" maxlength="40">
        <textarea id="blogger-channel-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
        <button id="blogger-create-btn" style="width:100%;">‚ûï –°–æ–∑–¥–∞—Ç—å –∏ –≤–æ–π—Ç–∏</button>
        <p style="margin-top:12px;text-align:center;"><button id="back-from-blogger" class="small-btn">‚Üê –ù–∞–∑–∞–¥</button></p>
    </div>

    <!-- === –§–û–†–ú–ê –í–•–û–î–ê –î–õ–Ø –ê–î–ú–ò–ù–ê (–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) === -->
    <div id="admin-login" class="card hidden">
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</h3>
        <input type="text" id="admin-channel-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
        <button id="admin-start-edit" style="width:100%;">üñäÔ∏è –ù–∞—á–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        <p style="margin-top:12px;text-align:center;"><button id="back-from-admin" class="small-btn">‚Üê –ù–∞–∑–∞–¥</button></p>
    </div>

    <!-- === –ü–ê–ù–ï–õ–¨ –ë–õ–û–ì–ï–†–ê (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞) === -->
    <div id="blogger-panel" class="hidden">
        <div class="channel-header">
            <h2 id="blogger-channel-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <button class="delete-channel" id="blogger-delete-channel">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª</button>
        </div>
        <p style="color:#aaa; margin-bottom: 10px;" id="blogger-channel-description"></p>
        
        <!-- –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–û–î–ü–ò–°–ß–ò–ö–û–í –î–õ–Ø –ë–õ–û–ì–ï–†–ê -->
        <div class="subs-display" id="blogger-subs-display">
            üë• –ü–æ–¥–ø–∏—Å—á–∏–∫–∏: <span id="blogger-subs-count" class="short-number">0</span>
        </div>

        <!-- –ú–û–ù–ï–¢–ò–ó–ê–¶–ò–Ø -->
        <div class="monetization-display">
            <span class="monetization-text">üí∞ –ë–∞–ª–∞–Ω—Å: <span id="blogger-balance">0</span> ‚ÇΩ</span>
            <button class="withdraw-btn" id="withdraw-btn">–í—ã–≤–µ—Å—Ç–∏</button>
        </div>
        
        <h3>üìº –í–∞—à–∏ –≤–∏–¥–µ–æ:</h3>
        <div id="blogger-video-list" class="scrollable" style="min-height: 180px; margin-bottom: 10px;">
            <!-- –≤–∏–¥–µ–æ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
            <p style="color:#666; text-align:center;">–ø–æ–∫–∞ –Ω–µ—Ç –≤–∏–¥–µ–æ</p>
        </div>
        <!-- –±–æ–ª—å—à–æ–π –ø–ª—é—Å –≤–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
        <div class="plus-icon" id="blogger-add-video-btn" title="–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ">+</div>
    </div>

    <!-- === –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê === -->
    <div id="admin-panel" class="hidden">
        <div class="channel-header">
            <h2 id="admin-channel-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <button id="admin-back-btn" class="small-btn">‚¨ÖÔ∏è –í—ã—Ö–æ–¥</button>
        </div>
        <!-- –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ —Å —Ä—É—á–Ω—ã–º –≤–≤–æ–¥–æ–º -->
        <div class="subs-row" id="admin-subs-row">
            <span>üë• –ü–æ–¥–ø–∏—Å—á–∏–∫–∏: <strong id="admin-subs-count" class="short-number">0</strong></span>
            <div class="subs-edit">
                <input type="number" id="admin-subs-input" min="0" value="0" placeholder="—á–∏—Å–ª–æ">
                <button id="admin-subs-set" class="small-btn success-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>
        <h3>üìΩÔ∏è –í—Å–µ –≤–∏–¥–µ–æ –∫–∞–Ω–∞–ª–∞</h3>
        <div id="admin-video-list" class="scrollable" style="max-height: 400px;">
            <!-- –≤–∏–¥–µ–æ —Å –∞–¥–º–∏–Ω—Å–∫–∏–º–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∞–º–∏ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥) + –∫–Ω–æ–ø–∫–∞ —Å–º–æ—Ç—Ä–µ—Ç—å -->
        </div>
    </div>

    <!-- === –ú–û–î–ê–õ–¨–ù–ê–Ø –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –í–ò–î–ï–û (–±–ª–æ–≥–µ—Ä) === -->
    <div id="video-modal" style="display: none; background: #1e1e1e; border-radius: 30px; padding: 20px; margin-top: 10px; border: 2px solid #3f3f3f;">
        <h3 style="margin-bottom: 12px;">‚ûï –ù–æ–≤–æ–µ –≤–∏–¥–µ–æ</h3>
        <input type="text" id="video-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ">
        <textarea id="video-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        <input type="url" id="video-link" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ YouTube (https://...)">
        <div class="btn-group">
            <button id="video-publish-btn" style="flex:2;">üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <button id="video-cancel-btn" style="flex:1; background:#3a2a2a;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
    // ========== FIREBASE ==========
    const firebaseConfig = {
        apiKey: "AIzaSyAu_wfaRhTsWNbsyFYmEigopqJck7ynxlU",
        authDomain: "messeger-0wo2h4.firebaseapp.com",
        databaseURL: "https://messeger-0wo2h4-default-rtdb.firebaseio.com",
        projectId: "messeger-0wo2h4",
        storageBucket: "messeger-0wo2h4.firebasestorage.app",
        messagingSenderId: "1057251395030",
        appId: "1:1057251395030:web:86f8f718ed938055e29077"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    let currentChannelKey = '';           
    let currentChannelData = null;         
    let currentRole = '';                 // 'blogger' –∏–ª–∏ 'admin'

    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª
    function formatNumberShort(num) {
        if (num === undefined || num === null) num = 0;
        if (num < 1000) return num.toString();
        
        if (num < 1000000) {
            let value = num / 1000;
            let rounded = Math.round(value * 10) / 10;
            let formatted = rounded.toString().replace('.', ',');
            return formatted + '–∫';
        } else {
            let value = num / 1000000;
            let rounded = Math.round(value * 10) / 10;
            let formatted = rounded.toString().replace('.', ',');
            return formatted + '–º';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (25‚ÇΩ –∑–∞ 100 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤)
    function calculateEarnings(views) {
        return Math.floor(views / 100) * 25;
    }

    // –†–∞—Å—á–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ (—Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã)
    function calculateAvailableBalance(channelData) {
        if (!channelData || !channelData.videos) return 0;
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–µ–æ
        const lastPaidViews = channelData.monetization?.lastPaidViews || {};
        let totalNewEarnings = 0;
        
        Object.entries(channelData.videos || {}).forEach(([videoId, video]) => {
            const currentViews = video.views || 0;
            const lastPaid = lastPaidViews[videoId] || 0;
            
            if (currentViews > lastPaid) {
                const newViews = currentViews - lastPaid;
                totalNewEarnings += calculateEarnings(newViews);
            }
        });
        
        return totalNewEarnings;
    }

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫–∞–Ω–∞–ª –±–ª–æ–≥–µ—Ä–∞ –≤ localStorage (–Ω–µ sessionStorage!)
    const STORAGE_KEY = 'youtube_dark_channel_permanent';
    
    function loadStoredChannel() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                const { key, role } = JSON.parse(stored);
                if (key && role === 'blogger') {
                    currentRole = role;
                    currentChannelKey = key;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    showLoader();
                    
                    db.ref('channels/' + key).once('value', snap => {
                        hideLoader();
                        if (snap.exists()) {
                            currentChannelData = snap.val();
                            renderBloggerPanel();
                            document.getElementById('existing-channel-info').innerHTML = `<span class="stored-badge">üîë –≤–∞—à –∫–∞–Ω–∞–ª: ${currentChannelData.displayName}</span>`;
                        } else {
                            // –∫–∞–Ω–∞–ª —É–¥–∞–ª—ë–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –æ—á–∏—â–∞–µ–º
                            localStorage.removeItem(STORAGE_KEY);
                            showElement('role-screen');
                        }
                    });
                    return true;
                }
            } catch (e) { 
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞', e);
                localStorage.removeItem(STORAGE_KEY);
            }
        }
        return false;
    }

    function showLoader() {
        // –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('role-screen').classList.add('hidden');
        document.getElementById('blogger-panel').innerHTML = '<div style="text-align:center; padding:40px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–∞...</div>';
        document.getElementById('blogger-panel').classList.remove('hidden');
    }

    function hideLoader() {
        // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —Ä–µ–Ω–¥–µ—Ä —Å–∞–º —Å–ø—Ä–∞–≤–∏—Ç—Å—è
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–ª–æ–≥–µ—Ä–∞ –Ω–∞–≤—Å–µ–≥–¥–∞ (–≤ localStorage)
    function storeBloggerChannel(key) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ key: key, role: 'blogger' }));
    }

    // –í—ã—Ö–æ–¥ (—Å–±—Ä–æ—Å) - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞
    function logout(keepStorage = false) {
        if (!keepStorage) localStorage.removeItem(STORAGE_KEY);
        currentChannelKey = '';
        currentChannelData = null;
        currentRole = '';
        showElement('role-screen');
    }

    function sanitizeName(name) {
        return name.trim().toLowerCase().replace(/[^a-z–∞-—è—ë0-9]/gi, '_').replace(/_{2,}/g, '_').replace(/^_|_$/g, '') || 'channel';
    }

    function showElement(id) {
        document.getElementById('role-screen').classList.add('hidden');
        document.getElementById('blogger-login').classList.add('hidden');
        document.getElementById('admin-login').classList.add('hidden');
        document.getElementById('blogger-panel').classList.add('hidden');
        document.getElementById('admin-panel').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    function formatDateToMSK(isoString) {
        if (!isoString) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        const d = new Date(isoString);
        return d.toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function loadChannel(key, role) {
        if (!key) return;
        const ref = db.ref('channels/' + key);
        ref.once('value', snap => {
            if (!snap.exists()) {
                alert('–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                if (role === 'blogger') {
                    localStorage.removeItem(STORAGE_KEY);
                    showElement('blogger-login');
                } else {
                    showElement('admin-login');
                }
                return;
            }
            currentChannelKey = key;
            currentChannelData = snap.val();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º monetization –µ—Å–ª–∏ –Ω–µ—Ç
            if (!currentChannelData.monetization) {
                currentChannelData.monetization = { lastPaidViews: {} };
            }
            
            if (role === 'blogger') {
                renderBloggerPanel();
            } else {
                renderAdminPanel();
            }
        });
    }

    // ========== –ë–õ–û–ì–ï–† ==========
    function renderBloggerPanel() {
        if (!currentChannelData) return;
        document.getElementById('blogger-channel-title').innerText = currentChannelData.displayName || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        document.getElementById('blogger-channel-description').innerText = currentChannelData.description || '–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
        
        document.getElementById('blogger-subs-count').innerText = formatNumberShort(currentChannelData.subscribers || 0);
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å
        const availableBalance = calculateAvailableBalance(currentChannelData);
        document.getElementById('blogger-balance').innerText = availableBalance.toLocaleString('ru-RU');
        
        const container = document.getElementById('blogger-video-list');
        container.innerHTML = '';
        const videos = currentChannelData.videos || {};
        const videoArray = Object.entries(videos).map(([id, v]) => ({ id, ...v }));
        videoArray.sort((a, b) => (b.publishedAt || '').localeCompare(a.publishedAt || ''));

        if (videoArray.length === 0) {
            container.innerHTML = '<p style="color:#666; text-align:center;">üïØÔ∏è –≤–∏–¥–µ–æ –Ω–µ—Ç</p>';
        } else {
            videoArray.forEach(v => {
                const div = document.createElement('div');
                div.className = 'video-item';
                
                const dateStr = formatDateToMSK(v.publishedAt);
                const videoEarnings = calculateEarnings(v.views || 0);
                const lastPaid = currentChannelData.monetization?.lastPaidViews?.[v.id] || 0;
                const unpaidViews = Math.max(0, (v.views || 0) - lastPaid);
                const unpaidEarnings = calculateEarnings(unpaidViews);
                
                div.innerHTML = `
                    <div style="font-weight:bold;font-size:1.1rem; margin-bottom:6px;">
                        ${escapeHtml(v.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}
                        <span class="video-earnings">üí∞ –≤—Å–µ–≥–æ: ${videoEarnings} ‚ÇΩ</span>
                        ${unpaidEarnings > 0 ? `<span class="video-earnings-new">üÜï +${unpaidEarnings} ‚ÇΩ</span>` : ''}
                    </div>
                    <div style="color:#ccc; margin:6px 0;">${escapeHtml(v.description || '')}</div>
                    <div class="date-badge">üìÖ ${dateStr}</div>
                    
                    <div class="video-metrics-column">
                        <div class="metric-row">
                            <span>üëÅÔ∏è</span>
                            <span class="metric-value short-number">${formatNumberShort(v.views || 0)}</span>
                        </div>
                        <div class="metric-row">
                            <span>üëç</span>
                            <span class="metric-value short-number">${formatNumberShort(v.likes || 0)}</span>
                        </div>
                        <div class="metric-row">
                            <span>üëé</span>
                            <span class="metric-value short-number">${formatNumberShort(v.dislikes || 0)}</span>
                        </div>
                        <div class="metric-row">
                            <span>üí¨</span>
                            <span class="metric-value short-number">${formatNumberShort(v.comments || 0)}</span>
                        </div>
                    </div>
                    
                    <div class="video-actions">
                        <button class="small-btn watch-video" data-link="${escapeHtml(v.youtubeLink || '#')}">‚ñ∂Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å</button>
                        <button class="small-btn danger-btn delete-video-blogger" data-videoid="${v.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        showElement('blogger-panel');

        document.querySelectorAll('.watch-video').forEach(btn => {
            btn.addEventListener('click', e => {
                const link = btn.getAttribute('data-link');
                if (link && link !== '#') window.open(link, '_blank');
                else alert('–°—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞');
            });
        });
        document.querySelectorAll('.delete-video-blogger').forEach(btn => {
            btn.addEventListener('click', e => {
                const videoId = btn.getAttribute('data-videoid');
                deleteVideoPrompt(videoId, 'blogger');
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã–≤–æ–¥–∞
        document.getElementById('withdraw-btn').onclick = () => {
            const confirmText = prompt('–í–≤–µ–¥–∏—Ç–µ –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤:');
            if (confirmText !== '–ü–û–î–¢–í–ï–†–î–ò–¢–¨') {
                alert('–í—ã–≤–æ–¥ –æ—Ç–º–µ–Ω—ë–Ω');
                return;
            }
            
            const availableBalance = calculateAvailableBalance(currentChannelData);
            if (availableBalance <= 0) {
                alert('–ù–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º lastPaidViews –¥–ª—è –≤—Å–µ—Ö –≤–∏–¥–µ–æ –¥–æ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
            const updates = {};
            const lastPaidViews = { ...(currentChannelData.monetization?.lastPaidViews || {}) };
            
            Object.keys(currentChannelData.videos || {}).forEach(videoId => {
                const views = currentChannelData.videos[videoId].views || 0;
                lastPaidViews[videoId] = views;
            });
            
            updates[`channels/${currentChannelKey}/monetization/lastPaidViews`] = lastPaidViews;
            
            db.ref().update(updates)
                .then(() => {
                    alert(`–í—ã–≤–µ–¥–µ–Ω–æ ${availableBalance} ‚ÇΩ`);
                    loadChannel(currentChannelKey, 'blogger');
                }).catch(e => alert('–û—à–∏–±–∫–∞: ' + e.message));
        };
    }

    function deleteVideoPrompt(videoId, role) {
        const confirmText = prompt('–í–≤–µ–¥–∏—Ç–µ –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ:');
        if (confirmText !== '–ü–û–î–¢–í–ï–†–î–ò–¢–¨') {
            alert('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
            return;
        }
        if (!currentChannelKey) return;
        
        // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –≤—ã–ø–ª–∞—Ç–∞—Ö –¥–ª—è —ç—Ç–æ–≥–æ –≤–∏–¥–µ–æ
        const updates = {};
        updates[`channels/${currentChannelKey}/videos/${videoId}`] = null;
        updates[`channels/${currentChannelKey}/monetization/lastPaidViews/${videoId}`] = null;
        
        db.ref().update(updates)
            .then(() => {
                alert('–í–∏–¥–µ–æ —É–¥–∞–ª–µ–Ω–æ');
                loadChannel(currentChannelKey, role);
            }).catch(e => alert('–û—à–∏–±–∫–∞: ' + e.message));
    }

    function deleteChannelPrompt(role) {
        const confirmText = prompt('–í–≤–µ–¥–∏—Ç–µ –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –¥–ª—è –£–î–ê–õ–ï–ù–ò–Ø –ö–ê–ù–ê–õ–ê (—ç—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ):');
        if (confirmText !== '–ü–û–î–¢–í–ï–†–î–ò–¢–¨') {
            alert('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
            return;
        }
        if (!currentChannelKey) return;
        db.ref(`channels/${currentChannelKey}`).remove()
            .then(() => {
                alert('–ö–∞–Ω–∞–ª —É–¥–∞–ª—ë–Ω');
                logout(false); // –æ—á–∏—â–∞–µ–º localStorage
            }).catch(e => alert('–û—à–∏–±–∫–∞: ' + e.message));
    }

    // ========== –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–† ==========
    function renderAdminPanel() {
        if (!currentChannelData) return;
        document.getElementById('admin-channel-title').innerText = currentChannelData.displayName + ' (–∞–¥–º–∏–Ω)';
        const subs = currentChannelData.subscribers || 0;
        document.getElementById('admin-subs-count').innerText = formatNumberShort(subs);
        document.getElementById('admin-subs-input').value = subs;

        const container = document.getElementById('admin-video-list');
        container.innerHTML = '';
        const videos = currentChannelData.videos || {};
        const videoArray = Object.entries(videos).map(([id, v]) => ({ id, ...v }));
        videoArray.sort((a, b) => (b.publishedAt || '').localeCompare(a.publishedAt || ''));

        if (videoArray.length === 0) {
            container.innerHTML = '<p style="color:#666;">–í–∏–¥–µ–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>';
        } else {
            videoArray.forEach(v => {
                const div = document.createElement('div');
                div.className = 'video-item';
                div.setAttribute('data-vid', v.id);
                
                const dateStr = formatDateToMSK(v.publishedAt);
                const videoEarnings = calculateEarnings(v.views || 0);
                
                div.innerHTML = `
                    <div class="admin-video-header">
                        <div><b>${escapeHtml(v.title)}</b> <span class="video-earnings">üí∞ ${videoEarnings} ‚ÇΩ</span></div>
                        <button class="small-btn watch-video-admin" data-link="${escapeHtml(v.youtubeLink || '#')}" style="padding:6px 12px;">‚ñ∂Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å</button>
                    </div>
                    <div style="color:#aaa; font-size:0.9rem; margin:4px 0;">${escapeHtml(v.description || '')}</div>
                    <div class="date-badge">üìÖ ${dateStr}</div>
                    
                    <div class="video-metrics-column">
                        <div class="metric-row">
                            <span>üëÅÔ∏è</span>
                            <span class="metric-value short-number">${formatNumberShort(v.views || 0)}</span>
                        </div>
                        <div class="metric-row">
                            <span>üëç</span>
                            <span class="metric-value short-number">${formatNumberShort(v.likes || 0)}</span>
                        </div>
                        <div class="metric-row">
                            <span>üëé</span>
                            <span class="metric-value short-number">${formatNumberShort(v.dislikes || 0)}</span>
                        </div>
                        <div class="metric-row">
                            <span>üí¨</span>
                            <span class="metric-value short-number">${formatNumberShort(v.comments || 0)}</span>
                        </div>
                    </div>
                    
                    <div class="admin-control">
                        <div class="stat-edit-row">
                            <label>üëÅÔ∏è</label>
                            <input type="number" class="admin-views-input" data-id="${v.id}" value="${v.views || 0}" min="0">
                            <button class="small-btn admin-set-btn" data-field="views" data-id="${v.id}">–£—Å—Ç</button>
                        </div>
                        <div class="stat-edit-row">
                            <label>üëç</label>
                            <input type="number" class="admin-likes-input" data-id="${v.id}" value="${v.likes || 0}" min="0">
                            <button class="small-btn admin-set-btn" data-field="likes" data-id="${v.id}">–£—Å—Ç</button>
                        </div>
                        <div class="stat-edit-row">
                            <label>üëé</label>
                            <input type="number" class="admin-dislikes-input" data-id="${v.id}" value="${v.dislikes || 0}" min="0">
                            <button class="small-btn admin-set-btn" data-field="dislikes" data-id="${v.id}">–£—Å—Ç</button>
                        </div>
                        <div class="stat-edit-row">
                            <label>üí¨</label>
                            <input type="number" class="admin-comments-input" data-id="${v.id}" value="${v.comments || 0}" min="0">
                            <button class="small-btn admin-set-btn" data-field="comments" data-id="${v.id}">–£—Å—Ç</button>
                        </div>
                        <button class="small-btn danger-btn admin-delete-video" data-id="${v.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–∏–¥–µ–æ</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        showElement('admin-panel');
        attachAdminListeners();
    }

    function attachAdminListeners() {
        document.getElementById('admin-subs-set').onclick = () => {
            const input = document.getElementById('admin-subs-input');
            const val = parseInt(input.value, 10);
            if (isNaN(val) || val < 0) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ'); return; }
            db.ref(`channels/${currentChannelKey}/subscribers`).set(val)
                .then(() => loadChannel(currentChannelKey, 'admin'));
        };

        document.querySelectorAll('.admin-set-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const field = btn.dataset.field;
                const videoId = btn.dataset.id;
                let input;
                if (field === 'views') input = document.querySelector(`.admin-views-input[data-id="${videoId}"]`);
                else if (field === 'likes') input = document.querySelector(`.admin-likes-input[data-id="${videoId}"]`);
                else if (field === 'dislikes') input = document.querySelector(`.admin-dislikes-input[data-id="${videoId}"]`);
                else if (field === 'comments') input = document.querySelector(`.admin-comments-input[data-id="${videoId}"]`);
                if (!input) return;
                const val = parseInt(input.value, 10);
                if (isNaN(val) || val < 0) { alert('–ß–∏—Å–ª–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â• 0'); return; }
                db.ref(`channels/${currentChannelKey}/videos/${videoId}/${field}`).set(val)
                    .then(() => loadChannel(currentChannelKey, 'admin'));
            });
        });

        document.querySelectorAll('.watch-video-admin').forEach(btn => {
            btn.addEventListener('click', e => {
                const link = btn.getAttribute('data-link');
                if (link && link !== '#') window.open(link, '_blank');
                else alert('–°—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞');
            });
        });

        document.querySelectorAll('.admin-delete-video').forEach(btn => {
            btn.addEventListener('click', e => {
                const videoId = btn.dataset.id;
                deleteVideoPrompt(videoId, 'admin');
            });
        });
    }

    function createBloggerChannel() {
        const displayName = document.getElementById('blogger-channel-name').value.trim();
        if (!displayName) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞'); return; }
        const desc = document.getElementById('blogger-channel-desc').value.trim();
        const key = sanitizeName(displayName);
        if (!key) { alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è'); return; }

        const ref = db.ref('channels/' + key);
        ref.once('value', snap => {
            if (snap.exists()) {
                alert('–ö–∞–Ω–∞–ª —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –∏–º—è.');
                return;
            }
            const newChannel = {
                displayName: displayName,
                description: desc,
                subscribers: 0,
                createdAt: new Date().toISOString(),
                monetization: { lastPaidViews: {} },
                videos: {}
            };
            ref.set(newChannel).then(() => {
                currentChannelKey = key;
                currentRole = 'blogger';
                storeBloggerChannel(key); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–≤—Å–µ–≥–¥–∞
                loadChannel(key, 'blogger');
            }).catch(e => alert(e.message));
        });
    }

    function adminStartEdit() {
        const name = document.getElementById('admin-channel-name').value.trim();
        if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞'); return; }
        const key = sanitizeName(name);
        db.ref('channels/' + key).once('value', snap => {
            if (!snap.exists()) {
                alert('–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            currentRole = 'admin';
            loadChannel(key, 'admin');
        });
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe.replace(/[&<>"]/g, function(m) {
            if(m === '&') return '&amp;'; if(m === '<') return '&lt;'; if(m === '>') return '&gt;'; if(m === '"') return '&quot;';
            return m;
        });
    }

    function publishVideo() {
        const title = document.getElementById('video-title').value.trim();
        const desc = document.getElementById('video-desc').value.trim();
        const link = document.getElementById('video-link').value.trim();
        if (!title || !link) { alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—Å—ã–ª–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã'); return; }
        if (!link.startsWith('http')) { alert('–°—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://'); return; }

        const newVideo = {
            title, description: desc, youtubeLink: link,
            publishedAt: new Date().toISOString(),
            views: 0, likes: 0, dislikes: 0, comments: 0
        };
        const videoRef = db.ref(`channels/${currentChannelKey}/videos`).push();
        videoRef.set(newVideo).then(() => {
            document.getElementById('video-title').value = '';
            document.getElementById('video-desc').value = '';
            document.getElementById('video-link').value = '';
            document.getElementById('video-modal').style.display = 'none';
            loadChannel(currentChannelKey, 'blogger');
        }).catch(e => alert(e));
    }

    window.onload = function() {
        // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫–∞–Ω–∞–ª
        const hasStored = loadStoredChannel();
        
        if (!hasStored) {
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏
            showElement('role-screen');
        }

        // –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏
        document.getElementById('choose-blogger').onclick = () => {
            if (currentRole === 'blogger' && currentChannelKey) {
                // —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–Ω–∞–ª ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –ø–∞–Ω–µ–ª—å –±–ª–æ–≥–µ—Ä–∞
                renderBloggerPanel();
            } else {
                showElement('blogger-login');
            }
        };
        document.getElementById('choose-admin').onclick = () => showElement('admin-login');

        document.getElementById('back-from-blogger').onclick = () => showElement('role-screen');
        document.getElementById('back-from-admin').onclick = () => showElement('role-screen');
        document.getElementById('admin-back-btn').onclick = () => {
            // –î–ª—è –∞–¥–º–∏–Ω–∞ –≤—ã—Ö–æ–¥ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è storage –±–ª–æ–≥–µ—Ä–∞
            currentRole = '';
            currentChannelKey = '';
            currentChannelData = null;
            showElement('role-screen');
        };

        // —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
        document.getElementById('blogger-create-btn').onclick = createBloggerChannel;

        // –∞–¥–º–∏–Ω —Å—Ç–∞—Ä—Ç
        document.getElementById('admin-start-edit').onclick = adminStartEdit;

        // –ø–ª—é—Å–∏–∫ –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –≤–∏–¥–µ–æ
        document.getElementById('blogger-add-video-btn').onclick = () => {
            document.getElementById('video-modal').style.display = 'block';
        };
        document.getElementById('video-cancel-btn').onclick = () => {
            document.getElementById('video-modal').style.display = 'none';
        };
        document.getElementById('video-publish-btn').onclick = publishVideo;

        // —É–¥–∞–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ (–±–ª–æ–≥–µ—Ä)
        document.getElementById('blogger-delete-channel').onclick = () => deleteChannelPrompt('blogger');
    };
</script>
</body>
</html>
